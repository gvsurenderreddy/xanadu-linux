#!/bin/bash
#elaborado por sinfallas
if [[ $USER != root ]]; then
echo -e "\e[00;31mERROR: DEBES SER ROOT\e[00m"
exit 1
fi
lock="/run/tor.lock"
lock2="/run/i2p.lock"
persistencia="/usr/local/bin/persistencia"
aptcmd="apt-get -q update && apt-get -q -y --force-yes install"
memoria=$(grep MemTotal /proc/meminfo | awk '{print $2}')

function espera ()
{
	sleep 30
}

function seguridad_1 ()
{
	modprobe -f ip_tables
	modprobe -f ip_conntrack
	modprobe -f iptable_filter
	modprobe -f iptable_nat
	modprobe -f ipt_physdev
	modprobe -f act_police
	systemctl enable ntp
	systemctl enable shorewall
	systemctl enable fail2ban
	systemctl enable psad
}

function antivirus_1 ()
{
	freshclam
	clamtk
}

function tor_1 ()
{
	echo "$(date +%d/%m/%Y-%r)" > $lock
	mv -f /etc/iceweasel/pref/iceweasel.js /etc/iceweasel/pref/iceweasel.bk
	mv -f /etc/iceweasel/pref/iceweasel.old /etc/iceweasel/pref/iceweasel.js
	systemctl start tor
	systemctl start polipo
	systemctl start privoxy
	systemctl restart dnsmasq
	tsocks -on
	systemctl start memlockd
}

function tor_0 ()
{
	rm -f $lock
	mv -f /etc/iceweasel/pref/iceweasel.js /etc/iceweasel/pref/iceweasel.old
	mv -f /etc/iceweasel/pref/iceweasel.bk /etc/iceweasel/pref/iceweasel.js
	systemctl stop privoxy
	systemctl stop polipo
	systemctl stop tor
	systemctl restart dnsmasq
	tsocks -off
	systemctl stop memlockd
	mv -f /etc/tor/torrc /etc/tor/torrc.obfs
	mv -f /etc/tor/torrc.old /etc/tor/torrc
	rm -rf /var/cache/polipo/*
}

function i2p_1 ()
{
	echo "$(date +%d/%m/%Y-%r)" > $lock2
	i2prouter start
}

function i2p_0 ()
{
	rm -f $lock2
	i2prouter stop
}

function hora_1 ()
{
	hwclock --systohc
	systemctl restart ntp
}

function compton_1 ()
{
	/usr/bin/compton --config /etc/compton.conf -b
}

function progress_1 ()
{
	zenity --progress --pulsate --no-cancel --text "Instalando Software, esto proceso puede tomar varios minutos, por favor espere" --auto-close & echo "$!" > /run/post-sub.pid
}

function progress_2 ()
{
	yad --fixed --progress-text="Instalando Software, esto proceso puede tomar varios minutos, por favor espere" --progress --pulsate --auto-close --auto-kill --skip-taskbar --center --title="INSTALANDO" & echo "$!" > /run/post-sub.pid
}

function optimizacion_1 ()
{
	dispositivo2=$(df / --output=source | tail -n1 | cut -c 19-54)
	dispositivo=$(blkid -U $dispositivo2 | cut -c 1-8)
	miswap=$(fdisk -l | grep swap | cut -c 1-9)
	miswap2=$(blkid -o export $miswap | grep UUID)
	quien=$(who | cut -d' ' -f1 | sort | uniq)
	if [[ -f /root/.optimizado ]]; then
		echo 1 > /dev/null
	else
		zenity --info --timeout 3 --text="Por favor reinicie el equipo, presione aceptar para continuar."		
		if [[ $(hostname) = xanadu ]]; then
			echo xanadu-$(printf '%02X%02X%02X\n' $((RANDOM%256)) $((RANDOM%256)) $((RANDOM%256))) > /etc/hostname
			sed -i 's_xanadu_'$(cat /etc/hostname)'_g' /etc/hosts
		fi
		swapoff /swapfile
		rm -f /etc/apt/preferences.d/exclude.pref
		rm -f /etc/apt/preferences		
		rm -f /etc/inittab
		rm -f /swapfile
		sed -i 's_/swapfile_#/swapfile_g' /etc/fstab
		sed -i 's_proc /proc_#proc /proc_g' /etc/fstab
		sed -i 's_miswap_#miswap_g' /etc/rc.local
		sed -i 's_swapon -f_#swapon -f_g' /etc/rc.local
		sed -i 's/autologin-user=user/#autologin-user=user/g' /etc/lightdm/lightdm.conf
		sed -i 's/autologin-user-timeout=0/#autologin-user-timeout=0/g' /etc/lightdm/lightdm.conf
		sed -i 's_umask 022_umask 027_g' /etc/init.d/rc
		sed -i 's_umask 022_umask 027_g' /etc/login.defs
		sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="quiet"/GRUB_CMDLINE_LINUX_DEFAULT="swapaccount=1 cgroup_enable=memory disable=1 disable_ipv6=1 security=apparmor panic=10 quiet splash"/g' /etc/default/grub
		update-grub2
		echo $dispositivo { >> /etc/hdparm.conf
		echo "lookahead = on" >> /etc/hdparm.conf
		echo "write_cache = on" >> /etc/hdparm.conf
		echo "spindown_time = 18" >> /etc/hdparm.conf
		echo "}" >> /etc/hdparm.conf
		echo "user ALL=(ALL) ALL" > /etc/sudoers.d/live
		echo "umask 027" >> /etc/profile
		echo "auth required pam_succeed_if.so user != root quiet" >> /etc/pam.d/lightdm
		echo "proc /proc proc defaults,hidepid=2 0 0" >> /etc/fstab
		echo "tmpfs /tmp tmpfs noatime,nosuid,noexec,nodev,rw 0 0" >> /etc/fstab
		echo "tmpfs /run tmpfs rw,nosuid,noexec,nodev,noatime,mode=755 0 0" >> /etc/fstab
		echo "tmpfs /var/cache/samba tmpfs noatime,nodev 0 0" >> /etc/fstab
		echo "tmpfs /var/spool tmpfs noatime,nodev 0 0" >> /etc/fstab
		echo "tmpfs /var/tmp tmpfs noatime,nosuid,noexec,nodev,rw 0 0" >> /etc/fstab
		echo $miswap2 "none swap sw 0 0" >> /etc/fstab
		chmod 600 /etc/sudoers
		chage -M 183 $quien
		chage -M 365 root
		adduser $quien sambashare
		yes "" | sensors-detect
		if [ -n "$(lspci | grep -E 'VGA|Display' | head -n1 | cut -d ':' -f3 | grep -F 'Intel')" ]; then
			echo 'Section "Device"' > /etc/X11/xorg.conf
			echo ' Identifier "intel"' >> /etc/X11/xorg.conf
			echo ' Driver "intel"' >> /etc/X11/xorg.conf
			echo ' BusID  "PCI:0:2:0"' >> /etc/X11/xorg.conf
			echo ' Option "AccelMethod" "SNA"' >> /etc/X11/xorg.conf
			echo ' Option "SwapbuffersWait" "false"' >> /etc/X11/xorg.conf
			echo ' Option "Tiling" "true"' >> /etc/X11/xorg.conf
			echo ' Option "BackingStore" "True"' >> /etc/X11/xorg.conf
			echo ' Option "XvMC" "on"' >> /etc/X11/xorg.conf
			echo ' Option "TripleBuffer" "true"' >> /etc/X11/xorg.conf
			echo ' Option "DRI" "true"' >> /etc/X11/xorg.conf
			echo 'EndSection' >> /etc/X11/xorg.conf
		fi
		echo "$(date +%d/%m/%Y-%r)" > /root/.optimizado
		if (( $memoria > 4096000 )); then
			echo "vm.swappiness = 10" >> /etc/sysctl.conf
			echo "tmpfs /var/cache/apt/archives tmpfs noatime,nodev 0 0" >> /etc/fstab
			for i in $quien; do
				echo "tmpfs /home/$i/.cache  tmpfs noatime,nodev,rw 0 0" >> /etc/fstab
			done
		fi
	fi
}

function kde_1 ()
{
	$aptcmd task-kde-desktop kde-full
}

function gnome_1 ()
{
	$aptcmd task-gnome-desktop gnome-session-fallback gnome-shell gnome-tweak-tool gnome
}

function xfce_1 ()
{
	$aptcmd task-xfce-desktop xfce4 xfce4-goodies xfce4-notifyd
}

function e17_1 ()
{
	$aptcmd e17
}

function cinnamon_1 ()
{
	$aptcmd cinnamon
}

function wine_1 ()
{
	$aptcmd playonlinux
}

function xbmc_1 ()
{
	$aptcmd xbmc python-software-properties pkg-config software-properties-common
}

function ati_1 ()
{
	$aptcmd fglrx-atieventsd fglrx-control fglrx-driver fglrx-modules-dkms radeontool
}

function nvidia_1 ()
{
	$aptcmd nvclock nvidia-alternative nvidia-glx nvidia-installer-cleanup nvidia-kernel-common nvidia-kernel-dkms nvidia-settings nvidia-support nvidia-vdpau-driver nvidia-xconfig
}

function liquorix_1 ()
{
	$aptcmd linux-image-liquorix-686 linux-headers-liquorix-686
}

function icedove_1 ()
{
	$aptcmd icedove
}

function apparmor_1 ()
{
	$aptcmd apparmor-profiles menulibre mugshot ecryptfs-utils auditd passwdqc dnsutils
}

function limpiar_1 ()
{
	apt-get clean
	apt-get -y --force-yes autoremove
	apt-get -y purge $(deborphan)
}

function progress_limpiar_1 ()
{
	zenity --progress --pulsate --no-cancel --text "Realizando limpieza" --auto-close & echo "$!" > /run/post-sub.pid
}

function progress_limpiar_2 ()
{
	yad --fixed --progress-text="Realizando limpieza" --progress --pulsate --auto-close --auto-kill --skip-taskbar --center --title="LIMPIEZA" & echo "$!" > /run/post-sub.pid
}
