#!/usr/bin/env bash
# killloops 2014-02-21


if [[ $1 = "--debug" ]] ; then
	set -x
fi

username=$(cat /tmp/r2u_user)
error_log="/home/${username}/.refracta2usb/killloops.log"
touch "$error_log"
chown ${username}:${username} "$error_log"
exec 2>"$error_log"
source /usr/lib/refracta2usb/functions_r2u
yad_zenity_compat

select_loop () {

selection=$(find /dev -mindepth 1 -maxdepth 1 -name "loop[0-7]" -exec losetup {} \; | sort | \
	$DIALOG --list --column ' ' --height 220 --width 450 --title="Select Loop Device" \
	--text="
 Select the loop device you want to delete. If you pick one 
 that is still in use, it will not be deleted.
 
 If the list is empty, there are no loop devices set up. \n" )
	
	if [[ $? = 1 ]] ; then
		exit 0
	fi

strayloop=$(echo $selection | cut -d":" -f1)
delete_loop
}


delete_loop () {
report=$(losetup -d "$strayloop" 2>&1 | $DIALOG --$INFO \
--text=" If there's no error message below, the command worked. 
 OK to delete another loop. Cancel to exit. \n" --width 450)
	if [[ $? = 0 ]] ; then
		select_loop
	else
		exit 0
	fi
}


# Check that xserver is running and user is root.
[[ $DISPLAY ]] || { echo "There is no xserver running. Exiting..." ; exit 1 ; }
[[ $(id -u) -eq 0 ]] || { $DIALOG --title=Error --$ERROR --${BUTTON0}="OK"${BUTTON0NUM} \
--text="You need to be root\! \n\nCannot continue." ; exit 1 ; }


select_loop

exit 0
