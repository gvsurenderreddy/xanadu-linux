#!/usr/bin/env bash
# install_alt_bootloader 2014-02-21
TITLE="Install Alternate Boot Loader"


if [[ $1 = "--debug" ]] ; then
	set -x
fi

username=$(cat /tmp/r2u_user)
error_log="/home/${username}/.refracta2usb/install_alt_bootloader.log"
touch "$error_log"
chown ${username}:${username} "$error_log"
exec 2>"$error_log"


configfile="/etc/refracta2usb.conf"
source "$configfile"
source /usr/lib/refracta2usb/functions_r2u
yad_zenity_compat

if [[ $(id -u) != 0 ]] ; then
	echo -e "\t You need to be root!\n"
	warning_message=" You need to be root.  "
	warning_dialog
	exit 1
fi

device=$(cat /tmp/r2u_device)

if [[ -z "$device" ]] ; then
	$DIALOG --$WARNING  --title="$TITLE" --text=" No device was selected.\n Maybe you need to Rescan. " \
		--${BUTTON0}="OK"${BUTTON0NUM}
	exit 1
fi

if [[ -f /sbin/install-mbr ]] ; then
	echo "install-mbr is installed."
else
	$DIALOG --$WARNING --title="$TITLE" --text=" You need to install the mbr package to use this.  " \
		--${BUTTON0}="OK"${BUTTON0NUM}
	exit 1
fi

install-mbr $mbr_opt "$device"

if [[ $? = 0 ]] ; then
		finished_message="Alternate bootloader has been installed."
		finished_dialog
		exit 0
else
		$DIALOG --$WARNING --title="$TITLE" --text="install-mbr failed. See the log file."
			--${BUTTON0}="OK"${BUTTON0NUM}
		exit 1
fi
